<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Blind Test เครื่องดื่ม</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      max-width: 100%;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      overflow-x: auto;
    }
    table, th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px;
    }
    th {
      background-color: #f0f0f0;
    }
    input, select, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      max-width: 300px;
    }
    canvas {
      margin-top: 30px;
      max-width: 100%;
    }
    @media (min-width: 600px) {
      input, select, button {
        width: auto;
      }
    }
  </style>
</head>
<body>
  <h2>Blind Test เครื่องดื่ม</h2>

  <div>
    <label>ชื่อผู้ทดสอบ:</label><br>
    <input type="text" id="testerName" placeholder="เช่น a"><br>
    
    <label>เลือกเครื่องดื่ม (เรียงลำดับความชอบ):</label><br>
    <select id="rank1"><option value="">อันดับ 1</option></select>
    <select id="rank2"><option value="">อันดับ 2</option></select>
    <select id="rank3"><option value="">อันดับ 3</option></select><br>

    <button onclick="submitVote()">ส่งคะแนน</button>
  </div>

  <h3>ผลโหวต (Real-Time)</h3>
  <table id="resultsTable">
    <thead>
      <tr>
        <th>ชื่อผู้ทดสอบ</th>
        <th>อันดับ 1</th>
        <th>อันดับ 2</th>
        <th>อันดับ 3</th>
      </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
    <tfoot id="resultsFooter"></tfoot>
  </table>

  <canvas id="resultsChart" height="300"></canvas>

  <script>
    const drinks = ["A", "B", "C", "D", "E", "F", "G", "H"];
    const votes = [];

    // เติม dropdown
    [rank1, rank2, rank3].forEach(select => {
      drinks.forEach(d => {
        const option = document.createElement("option");
        option.value = d;
        option.textContent = d;
        select.appendChild(option);
      });
    });

    function submitVote() {
      const name = testerName.value.trim();
      const r1 = rank1.value, r2 = rank2.value, r3 = rank3.value;

      if (!name || !r1) {
        alert("กรุณากรอกชื่อและเลือกอย่างน้อยอันดับ 1");
        return;
      }

      const ranks = [r1, r2, r3].filter(Boolean);

      if (new Set(ranks).size !== ranks.length) {
        alert("เลือกรายการซ้ำกัน กรุณาเลือกไม่ซ้ำกัน");
        return;
      }

      votes.push({ name, ranks });

      // reset form
      testerName.value = "";
      [rank1, rank2, rank3].forEach(select => select.selectedIndex = 0);

      updateTable();
      updateChart();
    }

    function updateTable() {
      resultsBody.innerHTML = "";
      const countMap = {};
      drinks.forEach(d => countMap[d] = 0);

      votes.forEach(vote => {
        const row = document.createElement("tr");
        const nameCell = document.createElement("td");
        nameCell.textContent = vote.name;
        row.appendChild(nameCell);

        [0, 1, 2].forEach(i => {
          const cell = document.createElement("td");
          const drink = vote.ranks[i] || "-";
          cell.textContent = drink;
          row.appendChild(cell);
          if (drink !== "-") countMap[drink]++;
        });

        resultsBody.appendChild(row);
      });

      // footer
      resultsFooter.innerHTML = "";

      const sumRow = document.createElement("tr");
      const labelCell = document.createElement("td");
      labelCell.colSpan = 4;
      labelCell.style.textAlign = "right";
      labelCell.textContent = "คะแนนรวมแต่ละเครื่องดื่ม:";
      sumRow.appendChild(labelCell);

      drinks.forEach(d => {
        const td = document.createElement("td");
        td.textContent = countMap[d];
        sumRow.appendChild(td);
      });

      resultsFooter.appendChild(sumRow);
    }

    let chart;

    function updateChart() {
      const countMap = {};
      drinks.forEach(d => countMap[d] = 0);

      votes.forEach(vote => {
        vote.ranks.forEach(drink => {
          countMap[drink]++;
        });
      });

      const labels = drinks;
      const data = labels.map(d => countMap[d]);

      if (chart) chart.destroy();
      const ctx = document.getElementById("resultsChart").getContext("2d");

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "คะแนนรวม",
            data,
            backgroundColor: "rgba(0, 150, 200, 0.6)"
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              precision: 0
            }
          },
          plugins: {
            tooltip: { enabled: true },
            legend: { display: false }
          }
        },
        plugins: [{
          id: 'valueOnTop',
          afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            ctx.save();
            chart.getDatasetMeta(0).data.forEach((bar, i) => {
              const val = data.datasets[0].data[i];
              if (val > 0) {
                ctx.fillStyle = "#000";
                ctx.font = "14px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText(val, bar.x, bar.y - 6);
              }
            });
          }
        }]
      });
    }
  </script>
</body>
</html>
