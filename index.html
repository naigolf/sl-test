<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Blind Test เครื่องดื่ม (Real-Time)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .drink-select {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

<h1>Blind Test เครื่องดื่ม</h1>

<div>
  <label>ชื่อผู้ทดสอบ: <input type="text" id="testerName" /></label>
  <h3>เลือกเครื่องดื่มที่ชอบ เรียงลำดับจากมากไปน้อย:</h3>
  <div id="rankedDrinks"></div>
  <button onclick="submitVote()">ส่งคะแนน</button>
</div>

<hr>

<h2>ผลโหวต (Real-Time)</h2>
<table id="logTable">
  <thead>
    <tr>
      <th>ชื่อผู้ทดสอบ</th>
      <th>อันดับ 1</th>
      <th>อันดับ 2</th>
      <th>อันดับ 3</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<canvas id="barChart" height="100"></canvas>

<script>
  const drinks = ["ยี่ห้อ A", "ยี่ห้อ B", "ยี่ห้อ C", "ยี่ห้อ D"];
  const maxRank = 3; // เลือกได้สูงสุดกี่อันดับ
  const weight = [3, 2, 1]; // คะแนนถ่วงน้ำหนักสำหรับอันดับ 1–3
  let votes = {};
  let submittedNames = [];

  drinks.forEach(drink => votes[drink] = 0);

  // Render Select Boxes
  const rankedDiv = document.getElementById("rankedDrinks");
  for (let i = 0; i < maxRank; i++) {
    const select = document.createElement("select");
    select.className = "drink-select";
    select.innerHTML = `<option value="">-- อันดับ ${i+1} --</option>` +
      drinks.map(d => `<option value="${d}">${d}</option>`).join("");
    rankedDiv.appendChild(select);
    rankedDiv.appendChild(document.createElement("br"));
  }

  function submitVote() {
    const name = document.getElementById("testerName").value.trim();
    const selects = document.querySelectorAll(".drink-select");
    let selections = [];

    if (!name) {
      alert("กรุณากรอกชื่อ");
      return;
    }
    if (submittedNames.includes(name)) {
      alert("โหวตไปแล้ว");
      return;
    }

    // Get selected drinks
    selects.forEach(s => {
      if (s.value) selections.push(s.value);
    });

    // Check for duplicates
    if (new Set(selections).size !== selections.length) {
      alert("ห้ามเลือกซ้ำกันในแต่ละอันดับ");
      return;
    }

    // Apply weighted scores
    selections.forEach((drink, index) => {
      votes[drink] += weight[index];
    });

    // Save name
    submittedNames.push(name);

    // Log
    const row = document.createElement("tr");
    row.innerHTML = `<td>${name}</td>` +
      selections.map(d => `<td>${d}</td>`).join("") +
      Array(maxRank - selections.length).fill("<td>-</td>").join("");
    document.querySelector("#logTable tbody").appendChild(row);

    // Reset
    document.getElementById("testerName").value = "";
    selects.forEach(s => s.value = "");

    // Update chart
    updateChart();
  }

  // Chart
  let chart = new Chart(document.getElementById("barChart"), {
    type: 'bar',
    data: {
      labels: Object.keys(votes),
      datasets: [{
        label: 'คะแนนรวม',
        data: Object.values(votes),
        backgroundColor: 'rgba(75, 192, 192, 0.6)'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  function updateChart() {
    chart.data.datasets[0].data = Object.values(votes);
    chart.update();
  }
</script>

</body>
</html>
